<!doctype html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Minigame: Reaction Test Â· denni-rauschenberg.de</title>
  <meta name="description" content="" />

  <link rel="stylesheet" href="/assets/css/style.css" />
  <script>
  (function () {
    const THEME_KEY = "site_theme";
    const saved = localStorage.getItem(THEME_KEY);
    const theme = (saved === "dark") ? "dark" : "light"; // default: LIGHT
    document.documentElement.setAttribute("data-theme", theme);
  })();
</script>

</head>

<body>
  <a class="skip-link" href="#content">Zum Inhalt springen</a>

  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="/">
        <span class="brand-mark">DR</span>
        <span class="brand-text">Denni Rauschenberg</span>
      </a>

      <nav class="nav" aria-label="Hauptnavigation">
  <a class="nav-link" href="/">Start</a>
  <a class="nav-link" href="/ueber-mich/">Ãœber mich</a>
  <a class="nav-link" href="/projekte/">Projekte</a>
  <a class="nav-link nav-cta" href="/kontakt/">Kontakt</a>

  <div class="settings">
    <button
  class="icon-btn"
  id="settingsBtn"
  aria-label="Einstellungen Ã¶ffnen"
  aria-haspopup="dialog"
  aria-expanded="false"
>
  <img
    src="/assets/icons/gear-wheel-304395.svg"
    alt=""
    class="gear-img"
    aria-hidden="true"
  >
</button>



    <div class="settings-panel" id="settingsPanel" role="dialog" aria-label="Einstellungen" aria-hidden="true">
      <div class="settings-row">
        <div>
          <div class="settings-title">Theme</div>
          <div class="settings-hint">Dark mode aktivieren</div>
        </div>
        <label class="switch" aria-label="Dark Mode umschalten">
  <input id="themeToggle" type="checkbox" />
  <span class="switch-track" aria-hidden="true"></span>
  <span class="switch-thumb" aria-hidden="true"></span>
</label>

      </div>

      <div class="settings-row">
        <div>
          <div class="settings-title">Sprache</div>
          <div class="settings-hint"></div>
        </div>
        <select class="select" id="langSelect">
          <option value="de" selected>Deutsch</option>
          <option value="en">English</option>
        </select>
      </div>

      <div class="settings-row settings-row-last">
        <div class="settings-hint">
          Was willst du tun?
        </div>
      </div>
    </div>
  </div>
</nav>

    </div>
  </header>

  <main id="content" class="container content">
    
<h1>Minigame: Reaction Test</h1>
<p class="muted">Klicke erst, wenn die FlÃ¤che <strong>grÃ¼n</strong> wird. Zu frÃ¼h = Fehlstart.</p>

<div class="game card" id="game">
  <div class="game-top">
  <label class="name-field">
    <span class="muted">Name</span>
    <input id="playerName" class="input" type="text" maxlength="18" placeholder="z.B. Denni" />
  </label>

  <button class="btn btn-primary" id="btnStart">Start</button>
  <button class="btn btn-ghost" id="btnReset">Bestwert lÃ¶schen</button>
</div>

  <hr />

  <div class="leaderboard">
    <div class="leaderboard-head">
      <h2 class="leaderboard-title">Rangliste (global)</h2>
      <button class="btn btn-ghost" id="btnClearBoard">Rangliste neu laden</button>
    </div>

    <ol class="leaderboard-list" id="board"></ol>
    <p class="muted" style="margin-top:10px;">
      Diese Rangliste ist global und wird Ã¼ber Supabase gespeichert.
    </p>
  </div>


<div class="game-stats">
    <div><span class="muted">Letztes Ergebnis:</span> <strong id="last">â€“</strong></div>
    <div><span class="muted">Bestwert:</span> <strong id="best">â€“</strong></div>
  </div>
</div>


  <div class="game-area" id="area" role="button" tabindex="0" aria-label="Spielbereich">
    <div class="game-text" id="text">DrÃ¼cke auf â€žStartâ€œ.</div>
  </div>

  <div class="game-stats">
    <div><span class="muted">Letztes Ergebnis:</span> <strong id="last">â€“</strong></div>
    <div><span class="muted">Bestwert:</span> <strong id="best">â€“</strong></div>
  </div>
</div>

<script>
(() => {
  const btnStart = document.getElementById("btnStart");
  const btnReset = document.getElementById("btnReset");
  const btnClearBoard = document.getElementById("btnClearBoard");

  const nameInput = document.getElementById("playerName");
  const area = document.getElementById("area");
  const text = document.getElementById("text");

  const lastEl = document.getElementById("last");
  const bestEl = document.getElementById("best");
  const boardEl = document.getElementById("board");
  if (
    !btnStart ||
    !btnReset ||
    !btnClearBoard ||
    !nameInput ||
    !area ||
    !text ||
    !lastEl ||
    !bestEl ||
    !boardEl
  ) {
    console.error("Minigame UI Elemente fehlen im HTML.");
    return;
  }

  const GAME = "reaction";

  // Lokal: nur Name + persÃ¶nlicher Bestwert (optional)
  const KEY_NAME = "reaction_player_name";
  const KEY_BEST = "reaction_best_ms";

  let state = "idle"; // idle | waiting | ready | done
  let startTime = 0;
  let timer = null;

  function jsonFetch(url, opts) {
    return fetch(url, opts).then(async (r) => {
      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data.error || "Request failed");
      return data;
    });
  }

  function getName() {
    return (nameInput.value || "").trim();
  }

  function loadName() {
    const saved = localStorage.getItem(KEY_NAME);
    if (saved) nameInput.value = saved;
  }

  function saveName() {
    const n = getName();
    if (n) localStorage.setItem(KEY_NAME, n);
  }

  function readBest() {
    const v = localStorage.getItem(KEY_BEST);
    return v ? Number(v) : null;
  }

  function setBest(ms) {
    localStorage.setItem(KEY_BEST, String(ms));
  }

  function renderBest() {
    const best = readBest();
    bestEl.textContent = best == null ? "â€“" : best + " ms";
  }

  function setMode(mode) {
    area.dataset.mode = mode;
  }

  function resetToIdle(msg = "Gib deinen Namen ein und drÃ¼cke auf â€žStartâ€œ.") {
    state = "idle";
    setMode("idle");
    text.textContent = msg;
    clearTimeout(timer);
    timer = null;
  }

  async function loadLeaderboard() {
    boardEl.innerHTML = `<li class="muted">Lade Ranglisteâ€¦</li>`;
    try {
      const res = await jsonFetch(`/.netlify/functions/leaderboard?game=${encodeURIComponent(GAME)}`);
      const items = res.top || [];
      if (!items.length) {
        boardEl.innerHTML = `<li class="muted">Noch keine EintrÃ¤ge. Leg los ðŸ™‚</li>`;
        return;
      }
      boardEl.innerHTML = items.map((it, idx) => {
        const safeName = String(it.name).replace(/</g,"&lt;").replace(/>/g,"&gt;");
        return `
          <li class="board-row">
            <span class="rank">#${idx + 1}</span>
            <span class="player">${safeName}</span>
            <span class="score">${it.ms} ms</span>
          </li>
        `;
      }).join("");
    } catch (e) {
      boardEl.innerHTML = `<li class="muted">Rangliste konnte nicht geladen werden.</li>`;
      console.error(e);
    }
  }

  async function submitScore(name, ms) {
    // POST an Netlify Function
    return jsonFetch("/.netlify/functions/score", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ game: GAME, name, ms }),
    });
  }

  function start() {
    const name = getName();
    if (!name) {
      nameInput.focus();
      resetToIdle("Bitte zuerst einen Namen eingeben (oben).");
      return;
    }
    if (name.length > 18) {
      nameInput.focus();
      resetToIdle("Name zu lang (max. 18 Zeichen).");
      return;
    }

    saveName();

    if (state === "waiting" || state === "ready") return;

    state = "waiting";
    setMode("waiting");
    text.textContent = "Warteâ€¦ nicht klicken!";
    clearTimeout(timer);

    const delay = 1200 + Math.random() * 2800; // 1.2â€“4.0s
    timer = setTimeout(() => {
      state = "ready";
      setMode("ready");
      text.textContent = "JETZT!";
      startTime = performance.now();
    }, delay);
  }

  async function clickArea() {
    if (state === "idle") return;

    if (state === "waiting") {
      resetToIdle("Zu frÃ¼h! ðŸ˜… DrÃ¼cke erneut auf â€žStartâ€œ.");
      lastEl.textContent = "Fehlstart";
      return;
    }

    if (state === "ready") {
      const ms = Math.round(performance.now() - startTime);
      state = "done";
      setMode("done");
      text.textContent = `Reaktionszeit: ${ms} ms (klicke â€žStartâ€œ fÃ¼r die nÃ¤chste Runde)`;
      lastEl.textContent = ms + " ms";

      // persÃ¶nlicher Bestwert lokal
      const best = readBest();
      if (best == null || ms < best) setBest(ms);
      renderBest();

      // global speichern + Rangliste neu laden
      try {
        await submitScore(getName(), ms);
        await loadLeaderboard();
      } catch (e) {
        console.error(e);
        // Score ok anzeigen, aber Hinweis:
        text.textContent = `Reaktionszeit: ${ms} ms (Speichern fehlgeschlagen â€“ probier spÃ¤ter nochmal)`;
      }
      return;
    }
  }

  btnStart.addEventListener("click", start);

  // Bestwert lokal zurÃ¼cksetzen (optional)
  btnReset.addEventListener("click", () => {
    localStorage.removeItem(KEY_BEST);
    renderBest();
  });

  // Globale Rangliste kann der User NICHT lÃ¶schen (wÃ¤re ja global)
  // Button behalten wir, aber machen ihn zu "neu laden"
  btnClearBoard.textContent = "Rangliste neu laden";
  btnClearBoard.addEventListener("click", loadLeaderboard);

  nameInput.addEventListener("change", saveName);
  nameInput.addEventListener("blur", saveName);

  area.addEventListener("click", () => { clickArea(); });
  area.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      clickArea();
    }
  });

  loadName();
  renderBest();
  loadLeaderboard();
  resetToIdle();
})();
</script>


  </main>

  <footer class="site-footer">
    <div class="container footer-inner">
      <p class="muted">Â© 2025 Denni Rauschenberg</p>
      <p class="footer-links">
        <a href="/impressum/">Impressum</a>
        <span class="dot">Â·</span>
        <a href="/datenschutz/">Datenschutz</a>
      </p>
    </div>
  </footer>
<script>
(() => {
  const btn = document.getElementById("settingsBtn");
  const panel = document.getElementById("settingsPanel");
  const themeToggle = document.getElementById("themeToggle");
  const langSelect = document.getElementById("langSelect");

  if (!btn || !panel || !themeToggle || !langSelect) return;

  // --- Theme (persisted) ---
  const THEME_KEY = "site_theme"; // "light" | "dark"

  function applyTheme(t) {
    document.documentElement.dataset.theme = t;
    localStorage.setItem(THEME_KEY, t);
  }

  const saved = localStorage.getItem(THEME_KEY);
  applyTheme(saved === "dark" ? "dark" : "light"); // default light

  // initial state fÃ¼r Switch setzen
themeToggle.checked = (document.documentElement.dataset.theme === "dark");

themeToggle.addEventListener("change", () => {
  applyTheme(themeToggle.checked ? "dark" : "light");
});


  // --- Settings panel ---
  function openPanel() {
    panel.classList.add("open");
    panel.setAttribute("aria-hidden", "false");
    btn.setAttribute("aria-expanded", "true");
  }
  function closePanel() {
    panel.classList.remove("open");
    panel.setAttribute("aria-hidden", "true");
    btn.setAttribute("aria-expanded", "false");
  }

  btn.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    panel.classList.contains("open") ? closePanel() : openPanel();
  });

  document.addEventListener("click", () => closePanel());
  panel.addEventListener("click", (e) => e.stopPropagation());
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closePanel();
  });

  // --- Language placeholder ---
  langSelect.addEventListener("change", () => {
    alert("Sprache kommt als nÃ¤chster Schritt ðŸ™‚");
    langSelect.value = "de";
  });
})();
</script>

</body>
</html>
